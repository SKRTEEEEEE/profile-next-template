name: ğŸ§ª Test Coverage
on:
  pull_request:
    branches: [ main, master, buildn ]
  push:
    branches: [ main ]

jobs:
  test:
    timeout-minutes: 30
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
    - name: Checkout ğŸ›¬
      uses: actions/checkout@v6
      with:
        submodules: recursive
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Initialize submodules ğŸ“¦
      run: |
        git submodule update --init --recursive
        git submodule foreach --recursive 'npm ci || echo "No package.json in $(pwd)"'

    - name: Reset CI artifacts ğŸ§¹
      run: |
        rm -rf docs/test-results docs/coverage .nyc_output || true
        mkdir -p docs/test-results docs/coverage/vitest docs/coverage/playwright

    - name: Setup Node âš™ï¸
      uses: actions/setup-node@v6
      with:
        node-version: lts/*
        cache: 'npm'

    - name: Install dependencies ğŸ“©
      run: npm ci
      env:
        NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

    - name: Get Playwright version
      id: playwright-version
      run: echo "PLAYWRIGHT_VERSION=$(node -e "console.log(require('./package-lock.json').packages['node_modules/@playwright/test'].version)")" >> $GITHUB_OUTPUT

    - name: Cache Playwright browsers
      uses: actions/cache@v4
      id: playwright-cache
      with:
        path: ~/.cache/ms-playwright
        key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.PLAYWRIGHT_VERSION }}

    - name: Install Playwright Browsers
      if: steps.playwright-cache.outputs.cache-hit != 'true'
      run: npx playwright install --with-deps

    - name: Install Playwright dependencies only
      if: steps.playwright-cache.outputs.cache-hit == 'true'
      run: npx playwright install-deps

    # ============================================================
    # VITEST - Tests rÃ¡pidos sin servidor (~2s)
    # ============================================================
    - name: Run Vitest with coverage âš¡
      run: npm run vitest:cov
      continue-on-error: false

    # ============================================================
    # PLAYWRIGHT - Tests con servidor (gestionado por webServer)
    # ============================================================
    - name: Build Next.js ğŸ“¦
      run: npm run build
      env:
        NODE_ENV: production

    - name: Run Playwright tests with NYC coverage ğŸ­
      run: npm run pw:cov
      continue-on-error: false
      env:
        CI: true
        NODE_ENV: production
        NEXT_PUBLIC_API_MOCKING: "enabled"
        NEXT_PUBLIC_THIRDWEB_CLIENT_ID: "ef963e90a058d6e8228ab34d38f50752"

    # ============================================================
    # COVERAGE PARSING - Vitest + Playwright
    # ============================================================
    - name: Ensure Playwright coverage summary
      if: always()
      run: npx nyc report --reporter=json-summary --report-dir=docs/coverage/playwright

    - name: Parse coverage data
      id: coverage
      if: always()
      run: |
        # Parse Vitest coverage
        VITEST_SUMMARY="./docs/coverage/vitest/coverage-summary.json"
        if [ -f "$VITEST_SUMMARY" ]; then
          V_STATEMENTS=$(node -e "console.log(require('${VITEST_SUMMARY}').total.statements.pct)")
          V_BRANCHES=$(node -e "console.log(require('${VITEST_SUMMARY}').total.branches.pct)")
          V_FUNCTIONS=$(node -e "console.log(require('${VITEST_SUMMARY}').total.functions.pct)")
          V_LINES=$(node -e "console.log(require('${VITEST_SUMMARY}').total.lines.pct)")
        else
          V_STATEMENTS=0
          V_BRANCHES=0
          V_FUNCTIONS=0
          V_LINES=0
        fi
        
        # Parse Playwright coverage
        PW_SUMMARY="./docs/coverage/playwright/coverage-summary.json"
        if [ -f "$PW_SUMMARY" ]; then
          P_STATEMENTS=$(node -e "console.log(require('${PW_SUMMARY}').total.statements.pct)")
          P_BRANCHES=$(node -e "console.log(require('${PW_SUMMARY}').total.branches.pct)")
          P_FUNCTIONS=$(node -e "console.log(require('${PW_SUMMARY}').total.functions.pct)")
          P_LINES=$(node -e "console.log(require('${PW_SUMMARY}').total.lines.pct)")
        else
          P_STATEMENTS=0
          P_BRANCHES=0
          P_FUNCTIONS=0
          P_LINES=0
        fi
        
        # Calculate combined average
        COMBINED_ST=$(node -e "console.log((($V_STATEMENTS + $P_STATEMENTS) / 2).toFixed(2))")
        COMBINED_BR=$(node -e "console.log((($V_BRANCHES + $P_BRANCHES) / 2).toFixed(2))")
        COMBINED_FN=$(node -e "console.log((($V_FUNCTIONS + $P_FUNCTIONS) / 2).toFixed(2))")
        COMBINED_LN=$(node -e "console.log((($V_LINES + $P_LINES) / 2).toFixed(2))")
        
        # Output all metrics
        echo "vitest_statements=$V_STATEMENTS" >> $GITHUB_OUTPUT
        echo "vitest_branches=$V_BRANCHES" >> $GITHUB_OUTPUT
        echo "vitest_functions=$V_FUNCTIONS" >> $GITHUB_OUTPUT
        echo "vitest_lines=$V_LINES" >> $GITHUB_OUTPUT
        
        echo "playwright_statements=$P_STATEMENTS" >> $GITHUB_OUTPUT
        echo "playwright_branches=$P_BRANCHES" >> $GITHUB_OUTPUT
        echo "playwright_functions=$P_FUNCTIONS" >> $GITHUB_OUTPUT
        echo "playwright_lines=$P_LINES" >> $GITHUB_OUTPUT
        
        echo "combined_statements=$COMBINED_ST" >> $GITHUB_OUTPUT
        echo "combined_branches=$COMBINED_BR" >> $GITHUB_OUTPUT
        echo "combined_functions=$COMBINED_FN" >> $GITHUB_OUTPUT
        echo "combined_lines=$COMBINED_LN" >> $GITHUB_OUTPUT
        
        echo "ğŸ“Š Vitest: Statements $V_STATEMENTS% | Branches $V_BRANCHES% | Functions $V_FUNCTIONS% | Lines $V_LINES%"
        echo "ğŸ­ Playwright: Statements $P_STATEMENTS% | Branches $P_BRANCHES% | Functions $P_FUNCTIONS% | Lines $P_LINES%"
        echo "ğŸ“ˆ Combined: Statements $COMBINED_ST% | Branches $COMBINED_BR% | Functions $COMBINED_FN% | Lines $COMBINED_LN%"

    # ============================================================
    # BADGES GENERATION - Only on main push
    # ============================================================
    - name: Create coverage badges ğŸ…
      if: github.ref == 'refs/heads/main'
      run: |
        mkdir -p .github/badges

        get_color() {
          local value=$(echo "$1" | awk '{printf "%.0f", $1}')
          if [ "$value" -ge 80 ]; then
            echo "brightgreen"
          elif [ "$value" -ge 60 ]; then
            echo "yellow"
          elif [ "$value" -ge 40 ]; then
            echo "orange"
          else
            echo "red"
          fi
        }

        # Combined badges (averaged)
        ST_COLOR=$(get_color "${{ steps.coverage.outputs.combined_statements }}")
        BR_COLOR=$(get_color "${{ steps.coverage.outputs.combined_branches }}")
        FN_COLOR=$(get_color "${{ steps.coverage.outputs.combined_functions }}")
        LN_COLOR=$(get_color "${{ steps.coverage.outputs.combined_lines }}")

        cat > .github/badges/coverage-statements.json << EOF
        {
          "schemaVersion": 1,
          "label": "statements",
          "message": "${{ steps.coverage.outputs.combined_statements }}%",
          "color": "${ST_COLOR}",
          "style": "flat-square"
        }
        EOF

        cat > .github/badges/coverage-branches.json << EOF
        {
          "schemaVersion": 1,
          "label": "branches",
          "message": "${{ steps.coverage.outputs.combined_branches }}%",
          "color": "${BR_COLOR}",
          "style": "flat-square"
        }
        EOF

        cat > .github/badges/coverage-functions.json << EOF
        {
          "schemaVersion": 1,
          "label": "functions",
          "message": "${{ steps.coverage.outputs.combined_functions }}%",
          "color": "${FN_COLOR}",
          "style": "flat-square"
        }
        EOF

        cat > .github/badges/coverage-lines.json << EOF
        {
          "schemaVersion": 1,
          "label": "lines",
          "message": "${{ steps.coverage.outputs.combined_lines }}%",
          "color": "${LN_COLOR}",
          "style": "flat-square"
        }
        EOF

        # Vitest specific badges
        V_ST_COLOR=$(get_color "${{ steps.coverage.outputs.vitest_statements }}")
        V_BR_COLOR=$(get_color "${{ steps.coverage.outputs.vitest_branches }}")
        V_FN_COLOR=$(get_color "${{ steps.coverage.outputs.vitest_functions }}")
        V_LN_COLOR=$(get_color "${{ steps.coverage.outputs.vitest_lines }}")

        cat > .github/badges/vitest-statements.json << EOF
        {
          "schemaVersion": 1,
          "label": "statements",
          "message": "${{ steps.coverage.outputs.vitest_statements }}%",
          "color": "${V_ST_COLOR}",
          "style": "flat-square"
        }
        EOF

        cat > .github/badges/vitest-branches.json << EOF
        {
          "schemaVersion": 1,
          "label": "branches",
          "message": "${{ steps.coverage.outputs.vitest_branches }}%",
          "color": "${V_BR_COLOR}",
          "style": "flat-square"
        }
        EOF

        cat > .github/badges/vitest-functions.json << EOF
        {
          "schemaVersion": 1,
          "label": "functions",
          "message": "${{ steps.coverage.outputs.vitest_functions }}%",
          "color": "${V_FN_COLOR}",
          "style": "flat-square"
        }
        EOF

        cat > .github/badges/vitest-lines.json << EOF
        {
          "schemaVersion": 1,
          "label": "lines",
          "message": "${{ steps.coverage.outputs.vitest_lines }}%",
          "color": "${V_LN_COLOR}",
          "style": "flat-square"
        }
        EOF

        # Playwright specific badges
        P_ST_COLOR=$(get_color "${{ steps.coverage.outputs.playwright_statements }}")
        P_BR_COLOR=$(get_color "${{ steps.coverage.outputs.playwright_branches }}")
        P_FN_COLOR=$(get_color "${{ steps.coverage.outputs.playwright_functions }}")
        P_LN_COLOR=$(get_color "${{ steps.coverage.outputs.playwright_lines }}")

        cat > .github/badges/playwright-statements.json << EOF
        {
          "schemaVersion": 1,
          "label": "statements",
          "message": "${{ steps.coverage.outputs.playwright_statements }}%",
          "color": "${P_ST_COLOR}",
          "style": "flat-square"
        }
        EOF

        cat > .github/badges/playwright-branches.json << EOF
        {
          "schemaVersion": 1,
          "label": "branches",
          "message": "${{ steps.coverage.outputs.playwright_branches }}%",
          "color": "${P_BR_COLOR}",
          "style": "flat-square"
        }
        EOF

        cat > .github/badges/playwright-functions.json << EOF
        {
          "schemaVersion": 1,
          "label": "functions",
          "message": "${{ steps.coverage.outputs.playwright_functions }}%",
          "color": "${P_FN_COLOR}",
          "style": "flat-square"
        }
        EOF

        cat > .github/badges/playwright-lines.json << EOF
        {
          "schemaVersion": 1,
          "label": "lines",
          "message": "${{ steps.coverage.outputs.playwright_lines }}%",
          "color": "${P_LN_COLOR}",
          "style": "flat-square"
        }
        EOF

    - name: Commit coverage badges ğŸ“Œ
      if: github.ref == 'refs/heads/main'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Check if there are changes
        if [ -n "$(git status --porcelain .github/badges/*.json 2>/dev/null)" ]; then
          git add .github/badges/*.json
          git commit -m "chore: update coverage badges [skip ci]"
          git push
          echo "âœ… Coverage badges updated"
        else
          echo "â„¹ï¸ No badge changes to commit"
        fi

    # ============================================================
    # ARTIFACTS UPLOAD
    # ============================================================
    - uses: actions/upload-artifact@v5
      if: always()
      with:
        name: playwright-report
        path: docs/test-results/
        retention-days: 30
    
    - uses: actions/upload-artifact@v5
      if: always()
      with:
        name: vitest-coverage
        path: docs/coverage/vitest/
        retention-days: 30

    - uses: actions/upload-artifact@v5
      if: always()
      with:
        name: playwright-coverage
        path: docs/coverage/playwright/
        retention-days: 30

    # ============================================================
    # PR COMMENT with detailed metrics
    # ============================================================
    - name: Comment PR with coverage
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const body = `## ğŸ§ª Test Coverage Results
          
          ### ğŸ“Š Combined Coverage (Average)
          | Metric | Coverage |
          |--------|----------|
          | **Statements** | ${{ steps.coverage.outputs.combined_statements }}% |
          | **Branches** | ${{ steps.coverage.outputs.combined_branches }}% |
          | **Functions** | ${{ steps.coverage.outputs.combined_functions }}% |
          | **Lines** | ${{ steps.coverage.outputs.combined_lines }}% |
          
          ### âš¡ Vitest Coverage (Unit Tests - Fast)
          | Metric | Coverage |
          |--------|----------|
          | Statements | ${{ steps.coverage.outputs.vitest_statements }}% |
          | Branches | ${{ steps.coverage.outputs.vitest_branches }}% |
          | Functions | ${{ steps.coverage.outputs.vitest_functions }}% |
          | Lines | ${{ steps.coverage.outputs.vitest_lines }}% |
          
          ### ğŸ­ Playwright Coverage (Integration Tests)
          | Metric | Coverage |
          |--------|----------|
          | Statements | ${{ steps.coverage.outputs.playwright_statements }}% |
          | Branches | ${{ steps.coverage.outputs.playwright_branches }}% |
          | Functions | ${{ steps.coverage.outputs.playwright_functions }}% |
          | Lines | ${{ steps.coverage.outputs.playwright_lines }}% |
          
          ---
          
          ğŸ“¦ [View full reports in artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
